import { OSVulnerability, Severity } from "@/types/osv";
import { SBOMVulnerability } from "@/lib/sbom/types";
import { CVSS31, CVSS30 } from "@pandatix/js-cvss";

export const getCVE = (aliases: string[] | string | null): string | null => {
  if (Array.isArray(aliases)) {
    return aliases.find((alias) => alias.startsWith("CVE-")) || null;
  }
  if (typeof aliases === "string" && aliases.startsWith("CVE-")) {
    return aliases;
  }
  return null;
};

export const getCVSSFromOsvSeverity = (
  severity: { type: string; score: string }[],
): number | null => {
  const cvss = severity?.find((s) => s.type === "CVSS_V3");
  if (!cvss?.score) return null;
  try {
    if (cvss.score.startsWith("CVSS:3.1")) {
      const cvssObject = new CVSS31(cvss.score);
      return cvssObject.BaseScore();
    } else if (cvss.score.startsWith("CVSS:3.0")) {
      const cvssObject = new CVSS30(cvss.score);
      return cvssObject.BaseScore();
    }
    return null;
  } catch (error) {
    console.error("Error parsing OSV CVSS vector for:", cvss.score, error);
    return null;
  }
};

export const getSeverityFromOsvSeverity = (
  severity: { type: string; score: string }[],
): Severity => {
  const cvss = getCVSSFromOsvSeverity(severity);
  if (cvss === null) return "unknown";
  if (cvss >= 9.0) return "critical";
  if (cvss >= 7.0) return "high";
  if (cvss >= 4.0) return "medium";
  if (cvss > 0) return "low";
  return "unknown";
};

export const getCVSSFromSbomRatings = (
  ratings: SBOMVulnerability["ratings"],
): number | null => {
  const cvssRating = ratings?.find((r) => r.method?.startsWith("CVSS"));
  if (cvssRating?.score) return cvssRating.score;
  return null;
};

export const getSeverityFromSbomRatings = (
  ratings: SBOMVulnerability["ratings"],
): Severity => {
  const cvss = getCVSSFromSbomRatings(ratings);
  if (cvss === null) {
    const stringSeverity = ratings
      ?.find((r) => r.severity)
      ?.severity?.toLowerCase();
    if (stringSeverity === "critical") return "critical";
    if (stringSeverity === "high") return "high";
    if (stringSeverity === "medium") return "medium";
    if (stringSeverity === "low") return "low";
  } else {
    if (cvss >= 9.0) return "critical";
    if (cvss >= 7.0) return "high";
    if (cvss >= 4.0) return "medium";
    if (cvss > 0) return "low";
  }
  return "unknown";
};

export interface DisplayVulnerability {
  id: string;
  summary: string;
  details: string;
  cveId: string | null;
  cvssScore: number | null;
  severityText: Severity;
  externalUrl: string | null;
}

export const normalizeOsvVuln = (
  vuln: OSVulnerability,
): DisplayVulnerability => {
  return {
    id: vuln.id,
    summary: vuln.id || vuln.summary,
    details: vuln.details,
    cveId: getCVE(vuln.aliases),
    cvssScore: getCVSSFromOsvSeverity(vuln.severity),
    severityText: getSeverityFromOsvSeverity(vuln.severity),
    externalUrl:
      vuln.references && vuln.references.length > 0
        ? vuln.references[0].url
        : null,
  };
};

export const normalizeSbomVuln = (
  vuln: SBOMVulnerability,
): DisplayVulnerability => {
  return {
    id: vuln.id || "N/A",
    summary: vuln.id || vuln.description || "No summary available.",
    details: vuln.description || "No details available.",
    cveId: getCVE(vuln.id),
    cvssScore: getCVSSFromSbomRatings(vuln.ratings),
    severityText: getSeverityFromSbomRatings(vuln.ratings),
    externalUrl:
      (vuln.advisories && vuln.advisories.length > 0
        ? vuln.advisories[0].url
        : null) ||
      vuln.source?.url ||
      null,
  };
};
