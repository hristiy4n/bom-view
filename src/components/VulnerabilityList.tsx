import { SeverityBadge } from "./SeverityBadge";
import { AlertTriangle, ExternalLink } from "lucide-react";
import { OSVulnerability, Severity } from "@/types/osv";
import { CVSS31, CVSS30 } from "@pandatix/js-cvss";

interface VulnerabilityListProps {
  vulnerabilities: OSVulnerability[];
}

const getCVE = (aliases: string[]) => {
  return aliases?.find((alias) => alias.startsWith("CVE-")) || null;
};

const getCVSS = (
  severity: { type: string; score: string }[],
): number | null => {
  const cvss = severity?.find((s) => s.type === "CVSS_V3");
  if (!cvss?.score) return null;
  try {
    if (cvss.score.startsWith("CVSS:3.1")) {
      const cvssObject = new CVSS31(cvss.score);
      return cvssObject.BaseScore();
    } else if (cvss.score.startsWith("CVSS:3.0")) {
      const cvssObject = new CVSS30(cvss.score);
      return cvssObject.BaseScore();
    }
    return null;
  } catch (error) {
    console.error("Error parsing CVSS vector for:", cvss.score, error);
    return null;
  }
};

const getSeverity = (severity: { type: string; score: string }[]): Severity => {
  const cvss = getCVSS(severity);
  if (cvss === null) return "unknown";
  if (cvss >= 9.0) return "critical";
  if (cvss >= 7.0) return "high";
  if (cvss >= 4.0) return "medium";
  if (cvss > 0) return "low";
  return "unknown";
};

export function VulnerabilityList({ vulnerabilities }: VulnerabilityListProps) {
  if (vulnerabilities.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-8 text-muted-foreground">
        <div className="h-12 w-12 rounded-full bg-severity-low/10 flex items-center justify-center mb-3">
          <AlertTriangle className="h-6 w-6 text-severity-low" />
        </div>
        <p className="text-sm">No vulnerabilities detected</p>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      {vulnerabilities.map((vuln) => {
        const cve = getCVE(vuln.aliases);
        const cvss = getCVSS(vuln.severity);
        const severity = getSeverity(vuln.severity);
        const externalUrl =
          vuln.references && vuln.references.length > 0
            ? vuln.references[0].url
            : "#";

        return (
          <div
            key={vuln.id}
            className="rounded-lg border border-border bg-secondary/30 p-4 space-y-3"
          >
            <div className="flex items-start justify-between gap-4">
              <div className="space-y-1">
                <h4 className="font-medium text-foreground">{vuln.summary}</h4>
                <div className="flex items-center gap-2">
                  <SeverityBadge severity={severity} />
                  {cve && (
                    <span className="font-mono text-xs text-muted-foreground">
                      {cve}
                    </span>
                  )}
                  {cvss !== null && (
                    <span className="text-xs text-muted-foreground">
                      CVSS: {cvss}
                    </span>
                  )}
                </div>
              </div>
              <a
                href={externalUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="text-muted-foreground hover:text-primary transition-colors"
                onClick={(e) => e.stopPropagation()}
              >
                <ExternalLink className="h-4 w-4" />
              </a>
            </div>
            <p className="text-sm text-muted-foreground">{vuln.details}</p>
          </div>
        );
      })}
    </div>
  );
}
